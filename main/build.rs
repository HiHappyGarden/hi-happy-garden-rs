use std::env;
use std::fs::File;
use std::io::Write;
use std::path::PathBuf;

fn main() {
    // Read configuration from environment variables set by CMake
    let default_wifi_ssid = env::var("HHG_DEFAULT_WIFI_SSID").unwrap_or_else(|_| "\"\"".to_string());
    let default_wifi_password = env::var("HHG_DEFAULT_WIFI_PASSWORD").unwrap_or_else(|_| "\"\"".to_string());
    let default_wifi_hostname = env::var("HHG_DEFAULT_WIFI_HOSTNAME").unwrap_or_else(|_| "\"hi-happy-garden-rs\"".to_string());
    let default_wifi_enabled = env::var("HHG_DEFAULT_WIFI_ENABLED").unwrap_or_else(|_| "false".to_string()).parse::<bool>().unwrap_or(false);
    let default_timezone = env::var("HHG_DEFAULT_TIMEZONE").unwrap_or_else(|_| "0".to_string()).parse::<i16>().unwrap_or(60);
    let default_daylight_saving = env::var("HHG_DEFAULT_DAYLIGHT_SAVING").unwrap_or_else(|_| "false".to_string()).parse::<bool>().unwrap_or(true);
    let default_ntp_msg_len = env::var("HHG_DEFAULT_NTP_MSG_LEN").unwrap_or_else(|_| "48".to_string()).parse::<u16>().unwrap_or(48);
    let default_ntp_port = env::var("HHG_DEFAULT_NTP_PORT").unwrap_or_else(|_| "123".to_string()).parse::<u16>().unwrap_or(123);
    let default_ntp_server = env::var("HHG_DEFAULT_NTP_SERVER").unwrap_or_else(|_| "\"0.europe.pool.ntp.org\"".to_string());
    
    // Generate defaults.rs file
    let out_dir = PathBuf::from(env::var("OUT_DIR").unwrap());
    let dest_path = out_dir.join("defaults.rs");
    let mut f = File::create(&dest_path).unwrap();
    
    writeln!(f, "// Auto-generated by build.rs from CMake configuration").unwrap();
    writeln!(f, "").unwrap();
    writeln!(f, "pub const DEFAULT_WIFI_SSID: &str = {};", default_wifi_ssid).unwrap();
    writeln!(f, "pub const DEFAULT_WIFI_PASSWORD: &str = {};", default_wifi_password).unwrap();
    writeln!(f, "pub const DEFAULT_WIFI_HOSTNAME: &str = {};", default_wifi_hostname).unwrap();
    writeln!(f, "pub const DEFAULT_WIFI_ENABLED: bool = {};", default_wifi_enabled).unwrap();
    writeln!(f, "pub const DEFAULT_TIMEZONE: i16 = {};", default_timezone).unwrap();
    writeln!(f, "pub const DEFAULT_DAYLIGHT_SAVING: bool = {};", default_daylight_saving).unwrap();
    writeln!(f, "pub const DEFAULT_NTP_MSG_LEN: u16 = {};", default_ntp_msg_len).unwrap();
    writeln!(f, "pub const DEFAULT_NTP_PORT: u16 = {};", default_ntp_port).unwrap();
    writeln!(f, "pub const DEFAULT_NTP_SERVER: &str = {};", default_ntp_server).unwrap();

    
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_WIFI_SSID");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_WIFI_PASSWORD");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_WIFI_HOSTNAME");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_WIFI_ENABLED");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_TIMEZONE");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_DAYLIGHT_SAVING");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_NTP_MSG_LEN");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_NTP_PORT");
    println!("cargo:rerun-if-env-changed=HHG_DEFAULT_NTP_SERVER");

}
